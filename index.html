<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni Checklist Hub</title>
    
    <!-- PWA & SEO Meta -->
    <meta name="description" content="Omni Technologies Device Checklist Hub for fire-alarm inspections.">
    <meta name="theme-color" content="#1e293b">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'media',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              slate: {
                850: '#17202e',
              }
            }
          }
        }
      }
    </script>
    
    <!-- Custom Styles -->
    <style type="text/css">
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
      body { 
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      /* Custom focus rings for better accessibility */
      .focus-ring { @apply focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-sky-500; }
      /* Arrow rotation for accordion */
      [aria-expanded="true"] > .accordion-arrow { transform: rotate(180deg); }
      /* Styling for sortable table headers */
      .table-header-sortable:hover { @apply bg-slate-700; }
      .table-header-sortable svg { opacity: 0.3; }
      .table-header-sortable[aria-sort] svg { opacity: 1; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-850 text-slate-800 dark:text-slate-200">

    <div id="app-container" class="relative min-h-screen">
        
        <!-- Header -->
        <header class="bg-white/75 dark:bg-slate-900/75 backdrop-blur-sm sticky top-0 z-40 w-full border-b border-slate-200 dark:border-slate-800">
            <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <span class="text-2xl font-bold text-sky-600 dark:text-sky-500">‚úÖ</span>
                        <h1 class="ml-3 text-xl font-bold tracking-tight">Omni Checklist Hub</h1>
                    </div>
                </div>
                 <!-- Mobile Building Picker (becomes visible via JS) -->
                <div id="mobile-building-picker-container" class="sm:hidden pb-4"></div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
            <div class="flex flex-col sm:flex-row gap-8">
                <!-- Checklist Workspace -->
                <div id="checklist-workspace" class="flex-grow">
                    <!-- This will be populated with the checklist-workspace component -->
                     <div id="welcome-message" class="text-center py-20">
                        <h2 class="text-2xl font-semibold text-slate-600 dark:text-slate-400">Welcome, Inspector!</h2>
                        <p class="mt-2 text-slate-500">Please select a checklist from the list to begin.</p>
                    </div>
                </div>

                <!-- Desktop Building Picker Sidebar -->
                <aside id="desktop-building-picker-container" class="hidden sm:block sm:w-64 md:w-72 lg:w-80 flex-shrink-0">
                    <!-- This will be populated with the building-picker component -->
                </aside>
            </div>
        </main>

        <!-- Toasts/Notifications Container -->
        <div id="toast-container" aria-live="assertive" aria-atomic="true" class="fixed bottom-0 right-0 p-4 sm:p-6 space-y-3 z-50 w-full max-w-sm">
            <!-- Toasts will be injected here -->
        </div>

    </div>
    
    <!-- Checklist Data Source -->
    <script src="checklists.js"></script>

    <!-- Main Application Logic -->
    <script type="module">
        // --- UTILITIES ---
        const $ = (selector, parent = document) => parent.querySelector(selector);
        const $$ = (selector, parent = document) => parent.querySelectorAll(selector);

        /**
         * Simple debounce function to limit how often a function can run.
         */
        function debounce(func, delay = 250) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        /**
         * Sanitizes string to prevent XSS attacks by converting HTML to text.
         */
        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }

        /**
         * Shows a toast notification at the bottom-right of the screen.
         * @param {string} message - The message to display.
         * @param {string} type - 'info', 'success', or 'error'.
         */
        function showToast(message, type = 'info') {
            const container = $('#toast-container');
            if (!container) return;

            const toastId = `toast-${Date.now()}`;
            const colors = {
                success: 'bg-green-500 dark:bg-green-600',
                error: 'bg-red-500 dark:bg-red-600',
                info: 'bg-sky-500 dark:bg-sky-600',
            };

            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `transform transition-all duration-300 ease-out translate-y-4 opacity-0 p-4 rounded-lg shadow-lg text-white ${colors[type] || colors.info}`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `<p class="font-semibold">${escapeHTML(message)}</p>`;
            
            container.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
            });

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-full');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }
        
        // --- WEB COMPONENTS ---
        
        /**
         * BuildingPicker Component: Shows list of checklists as a select menu (mobile) or sidebar (desktop).
         * Data is sourced from the global `CHECKLISTS` variable from checklists.js.
         */
        class BuildingPicker extends HTMLElement {
            constructor() {
                super();
                this.isMobile = window.innerWidth < 640;
                // Check if the global CHECKLISTS variable exists
                this.checklists = typeof CHECKLISTS !== 'undefined' ? CHECKLISTS : [];
            }

            connectedCallback() {
                this.render();
                this.attachEventListeners();
                window.addEventListener('resize', debounce(() => this.handleResize(), 200));
            }

            render() {
                const containerId = this.isMobile ? '#mobile-building-picker-container' : '#desktop-building-picker-container';
                const otherContainerId = this.isMobile ? '#desktop-building-picker-container' : '#mobile-building-picker-container';
                const container = $(containerId);
                const otherContainer = $(otherContainerId);

                if(!container) return;

                // Populate the correct container based on screen size
                container.innerHTML = this.isMobile ? this.getMobileHTML() : this.getDesktopHTML();
                otherContainer.innerHTML = ''; // Clear the other container
            }

            getMobileHTML() {
                 if (this.checklists.length === 0) {
                    return `<p class="text-center text-sm text-slate-500">No checklists available.</p>`;
                 }
                 return `
                    <label for="building-select" class="sr-only">Select Checklist</label>
                    <select id="building-select" class="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm py-2 px-3 focus-ring sm:text-sm">
                        <option value="">-- Select a Checklist --</option>
                        ${this.checklists.map(c => `<option value="${c.key}">${escapeHTML(c.name)}</option>`).join('')}
                    </select>
                `;
            }

            getDesktopHTML() {
                return `
                    <div class="sticky top-20">
                        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-md p-4">
                            <h2 class="text-lg font-semibold mb-3">Checklists</h2>
                             <input type="search" id="building-search" placeholder="Search checklists..." class="mb-3 block w-full bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-md shadow-sm py-2 px-3 focus-ring sm:text-sm">
                            <ul id="building-list" class="space-y-1 max-h-[60vh] overflow-y-auto">
                                ${this.checklists.length === 0 ? `<li class="text-sm text-slate-500">No checklists available.</li>` : ''}
                                ${this.checklists.map(c => `
                                    <li>
                                        <a href="#" data-key="${c.key}" class="block p-2 rounded-md hover:bg-sky-100 dark:hover:bg-sky-900/50 focus-ring font-medium text-slate-700 dark:text-slate-300">
                                            ${escapeHTML(c.name)}
                                        </a>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            attachEventListeners() {
                if (this.isMobile) {
                    $('#building-select', document)?.addEventListener('change', (e) => {
                        if(e.target.value) this.selectChecklist(e.target.value);
                    });
                } else {
                    $('#building-list', this)?.addEventListener('click', (e) => {
                        e.preventDefault();
                        const link = e.target.closest('a');
                        if (link && link.dataset.key) {
                            // Visually mark the selected item
                            $$('a', this).forEach(a => a.classList.remove('bg-sky-100', 'dark:bg-sky-900/50'));
                            link.classList.add('bg-sky-100', 'dark:bg-sky-900/50');
                            this.selectChecklist(link.dataset.key);
                        }
                    });
                    $('#building-search', this)?.addEventListener('input', debounce((e) => this.filterChecklists(e.target.value), 200));
                }
            }

            /** Filters the desktop checklist list based on user input. */
            filterChecklists(query) {
                const q = query.toLowerCase();
                $$('#building-list li a').forEach(link => {
                    const name = link.textContent.toLowerCase();
                    link.parentElement.style.display = name.includes(q) ? '' : 'none';
                });
            }

            /** Dispatches an event to the main app when a checklist is selected. */
            selectChecklist(key) {
                document.dispatchEvent(new CustomEvent('checklist-selected', { detail: { key } }));
            }
            
            /** Re-renders the component if the viewport crosses the mobile breakpoint. */
            handleResize() {
                const newIsMobile = window.innerWidth < 640;
                if (newIsMobile !== this.isMobile) {
                    this.isMobile = newIsMobile;
                    this.render();
                    this.attachEventListeners();
                }
            }
        }
        customElements.define('building-picker', BuildingPicker);
        
        /**
         * ChecklistWorkspace Component: Renders tabs, tables, and manages inspection state for a selected checklist.
         */
        class ChecklistWorkspace extends HTMLElement {
            constructor() {
                super();
                this.data = null;
                this.inspected = new Set();
                this.checklistKey = null;
                this.sortState = {};
            }

            // Observe the 'building-key' attribute for changes.
            static get observedAttributes() { return ['building-key']; }

            attributeChangedCallback(name, oldValue, newValue) {
                if (name === 'building-key' && oldValue !== newValue) {
                    this.checklistKey = newValue;
                    this.loadChecklist();
                }
            }
            
            /** Loads the checklist data from the global CHECKLISTS variable. */
            loadChecklist() {
                this.innerHTML = `<div class="text-center py-20">Loading checklist...</div>`;
                try {
                    // Find the selected checklist by its unique key.
                    this.data = CHECKLISTS.find(c => c.key === this.checklistKey);
                    if (!this.data) {
                        throw new Error("Checklist not found.");
                    }
                    this.loadInspectedState();
                    this.render();
                } catch (error) {
                    showToast(error.message, 'error');
                    this.innerHTML = `<div class="text-center py-20 text-red-500">${escapeHTML(error.message)}</div>`;
                    console.error("Failed to load checklist:", error);
                }
            }
            
            /** Loads the saved progress for the current checklist from localStorage. */
            loadInspectedState() {
                this.inspected.clear();
                this.data.devices.forEach(device => {
                    // Unique key for each device in localStorage: checklistKey-deviceAddress
                    const key = `${this.checklistKey}-${device.address}`;
                    if(localStorage.getItem(key) === 'true') {
                        this.inspected.add(device.address);
                    }
                });
            }

            /** Saves the inspection state of a single device to localStorage. */
            saveInspectedState(address, isInspected) {
                const key = `${this.checklistKey}-${address}`;
                if (isInspected) {
                    localStorage.setItem(key, 'true');
                    this.inspected.add(address);
                } else {
                    localStorage.removeItem(key);
                    this.inspected.delete(address);
                }
            }
            
            /** Determines the category of a device based on its type string. */
            getDeviceCategory(deviceType) {
                const type = deviceType.toLowerCase();
                if (type.includes('smoke') || type.includes('heat') || type.includes('detector')) return 'Detectors';
                if (type.includes('module') || type.includes('pull')) return 'Modules & Pulls';
                if (type.includes('annunciator')) return 'Annunciators';
                if (type.includes('nac')) return 'NACs';
                return 'Modules & Pulls'; // Default category
            }

            /** Main render method for the entire workspace. */
            render() {
                if (!this.data) return;
                
                // Group devices by category
                const categories = {
                    'Detectors': { icon: 'üìü', devices: [] },
                    'Modules & Pulls': { icon: 'üß©', devices: [] },
                    'Annunciators': { icon: 'üì¢', devices: [] },
                    'NACs': { icon: 'üîî', devices: [] }
                };
                
                this.data.devices.forEach(device => {
                    const category = this.getDeviceCategory(device.deviceType);
                    categories[category].devices.push(device);
                });

                this.innerHTML = `
                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-lg p-4 sm:p-6">
                        <header class="mb-6">
                           <h2 class="text-2xl sm:text-3xl font-bold tracking-tight">${escapeHTML(this.data.name)}</h2>
                           <p class="text-slate-500 dark:text-slate-400">${escapeHTML(this.data.location)}</p>
                           <div class="mt-4 flex flex-wrap gap-2">
                                <button data-action="mark-all" class="text-sm bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 font-semibold py-1.5 px-3 rounded-md focus-ring">Mark All Inspected</button>
                                <button data-action="clear-all" class="text-sm bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 font-semibold py-1.5 px-3 rounded-md focus-ring">Clear All</button>
                                <button data-action="export" class="text-sm bg-green-200 hover:bg-green-300 dark:bg-green-800 dark:hover:bg-green-700 font-semibold py-1.5 px-3 rounded-md focus-ring">Export ‚úîÔ∏è List</button>
                           </div>
                        </header>
                        <div id="tab-container" class="border-b border-slate-200 dark:border-slate-700">
                           <div role="tablist" aria-label="Device Categories" class="flex flex-wrap -mb-px">
                              ${Object.keys(categories).map((cat, i) => {
                                const categoryId = cat.replace(/\s/g, '').replace('&', 'And');
                                return `
                                  <button role="tab" id="tab-${categoryId}" data-category="${escapeHTML(cat)}" aria-controls="panel-${categoryId}" aria-selected="${i===0}" class="tab-btn inline-flex items-center gap-2 p-3 sm:p-4 border-b-2 font-medium ${i===0 ? 'border-sky-500 text-sky-600 dark:text-sky-500' : 'border-transparent text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 hover:border-slate-300 dark:hover:border-slate-600'}">
                                     ${categories[cat].icon} ${cat}
                                  </button>
                                `}).join('')}
                           </div>
                        </div>
                        <div class="mt-6">
                           ${Object.keys(categories).map((cat, i) => {
                                const categoryId = cat.replace(/\s/g, '').replace('&', 'And');
                                return `
                                  <div role="tabpanel" id="panel-${categoryId}" data-category="${escapeHTML(cat)}" aria-labelledby="tab-${categoryId}" class="${i > 0 ? 'hidden' : ''}">
                                    ${this.renderCategoryContent(cat, categories[cat].devices)}
                                  </div>
                                `}).join('')}
                        </div>
                    </div>
                `;
                this.attachEventListeners();
            }
            
            /** Renders the content for a single category tab. */
            renderCategoryContent(category, devices) {
                if (devices.length === 0) {
                    return `<p class="text-slate-500 text-center py-8">No devices in this category.</p>`;
                }

                const total = devices.length;
                const inspectedCount = devices.filter(d => this.inspected.has(d.address)).length;
                const percent = total > 0 ? Math.round((inspectedCount / total) * 100) : 0;
                
                return `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1 text-sm font-medium">
                            <span class="text-slate-600 dark:text-slate-300">Progress</span>
                            <span>${inspectedCount} / ${total} inspected (${percent}%)</span>
                        </div>
                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                            <div class="bg-sky-600 h-2.5 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>
                    
                    <div class="my-4">
                        <input type="search" data-category="${escapeHTML(category)}" placeholder="Search this category..." class="block w-full bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-md shadow-sm py-2 px-3 focus-ring sm:text-sm">
                    </div>

                    <!-- Completed Devices Accordion -->
                    <div id="completed-${category.replace(/\s/g, '').replace('&', 'And')}"></div>

                    <!-- Active Devices Table -->
                    <div id="active-${category.replace(/\s/g, '').replace('&', 'And')}" class="overflow-x-auto"></div>
                `;
            }

            /** Renders both the 'Completed' accordion and the 'Active' table for a category. */
            renderTableAndAccordion(category) {
                const categoryId = category.replace(/\s/g, '').replace('&', 'And');
                const panel = $(`#panel-${categoryId}`, this);
                if(!panel) return;
                
                const allDevices = this.data.devices.filter(d => this.getDeviceCategory(d.deviceType) === category);
                
                // Sort devices if a sort state is set
                const sortKey = this.sortState[category]?.key;
                const sortDir = this.sortState[category]?.dir;
                if(sortKey && sortDir) {
                    allDevices.sort((a,b) => {
                        const valA = a[sortKey]?.toString() || '';
                        const valB = b[sortKey]?.toString() || '';
                        const comparison = valA.localeCompare(valB, undefined, { numeric: true });
                        return sortDir === 'asc' ? comparison : -comparison;
                    });
                }

                // Split devices into inspected and active lists
                const inspectedDevices = allDevices.filter(d => this.inspected.has(d.address));
                const activeDevices = allDevices.filter(d => !this.inspected.has(d.address));

                const completedContainer = $(`#completed-${categoryId}`, panel);
                const activeContainer = $(`#active-${categoryId}`, panel);

                completedContainer.innerHTML = this.renderAccordionHTML(category, inspectedDevices);
                activeContainer.innerHTML = this.renderTableHTML(category, activeDevices);
                
                this.attachTableEventListeners(panel);
            }

            /** Renders the accordion for completed items. */
            renderAccordionHTML(category, devices) {
                if (devices.length === 0) return '';
                const categoryId = category.replace(/\s/g, '').replace('&', 'And');

                return `
                    <div class="mb-4 border border-slate-200 dark:border-slate-700 rounded-lg">
                        <button aria-expanded="true" aria-controls="completed-list-${categoryId}" class="accordion-toggle w-full flex justify-between items-center p-3 font-semibold bg-slate-100 dark:bg-slate-800 rounded-t-lg focus-ring">
                           <span>Completed Devices (${devices.length})</span>
                           <svg class="accordion-arrow w-5 h-5 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="completed-list-${categoryId}">
                             ${this.renderTableHTML(category, devices)}
                        </div>
                    </div>
                `;
            }

            /** Renders the HTML for a table of devices. */
            renderTableHTML(category, devices) {
                 const headers = [
                    { key: 'loop', label: 'Loop' },
                    { key: 'address', label: 'Address' },
                    { key: 'model', label: 'Model' },
                    { key: 'serialNumber', label: 'Serial #' },
                    { key: 'messages', label: 'Location/Message' }
                ];
                return `
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-700 dark:text-slate-300 uppercase bg-slate-50 dark:bg-slate-800">
                            <tr>
                                ${headers.map(h => {
                                    const sortDir = this.sortState[category]?.key === h.key ? this.sortState[category]?.dir : null;
                                    return `<th scope="col" class="p-3 table-header-sortable cursor-pointer" data-sort-key="${h.key}" ${sortDir ? `aria-sort="${sortDir === 'asc' ? 'ascending':'descending'}"` : ''}>${h.label} <svg class="inline w-3 h-3">${sortDir === 'asc' ? '‚ñ≤' : (sortDir === 'desc' ? '‚ñº' : '')}</svg></th>`;
                                }).join('')}
                                <th scope="col" class="p-3 text-center">
                                    <span class="sr-only">Inspected</span>‚úÖ
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                           ${devices.map(d => this.renderRowHTML(d)).join('') || `<tr><td colspan="6" class="p-4 text-center text-slate-500">No devices to show.</td></tr>`}
                        </tbody>
                    </table>
                `;
            }

            /** Renders a single row in the device table. */
            renderRowHTML(device) {
                const isInspected = this.inspected.has(device.address);
                return `
                    <tr data-address="${device.address}" class="hover:bg-slate-50 dark:hover:bg-slate-800/50">
                        <td class="p-3 font-medium">${escapeHTML(String(device.loop))}</td>
                        <td class="p-3">${escapeHTML(String(device.address))}</td>
                        <td class="p-3">${escapeHTML(device.model)}</td>
                        <td class="p-3">${escapeHTML(device.serialNumber)}</td>
                        <td class="p-3 max-w-xs truncate" title="${escapeHTML(device.messages)}">${escapeHTML(device.messages)}</td>
                        <td class="p-3 text-center">
                            <input type="checkbox" data-address="${device.address}" class="h-5 w-5 rounded border-slate-300 text-sky-600 focus-ring" ${isInspected ? 'checked' : ''}>
                        </td>
                    </tr>
                `;
            }

            /** Attaches event listeners for the workspace (tabs, actions, search). */
            attachEventListeners() {
                // Initial render for the first tab
                const firstTab = $('.tab-btn', this);
                if (firstTab) {
                    this.renderTableAndAccordion(firstTab.dataset.category);
                }

                // Tab switching
                $$('.tab-btn', this).forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleTabClick(e));
                });

                // Global actions (Mark All, Clear All, Export)
                this.addEventListener('click', (e) => {
                    const action = e.target.closest('[data-action]')?.dataset.action;
                    if (action) this.handleGlobalAction(action);
                });

                // Accordion toggles
                this.addEventListener('click', (e) => {
                    const toggle = e.target.closest('.accordion-toggle');
                    if(toggle) {
                        const content = toggle.nextElementSibling;
                        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                        toggle.setAttribute('aria-expanded', !isExpanded);
                        content.classList.toggle('hidden');
                    }
                });

                // Search inputs
                $$('input[type="search"]', this).forEach(input => {
                    input.addEventListener('input', debounce((e) => {
                        this.filterTable(e.target.dataset.category, e.target.value);
                    }, 250));
                });
            }

            /** Attaches listeners specifically to tables (checkboxes, sorting). */
            attachTableEventListeners(panel) {
                 // Checkbox changes
                panel.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') this.handleCheckboxChange(e.target);
                });
                // Sorting clicks
                panel.addEventListener('click', (e) => {
                    const header = e.target.closest('.table-header-sortable');
                    if(header) {
                        const category = header.closest('[role=tabpanel]').dataset.category;
                        this.handleSort(category, header.dataset.sortKey);
                    }
                });
            }
            
            /** Handles switching between category tabs. */
            handleTabClick(e) {
                const clickedTab = e.currentTarget;
                const category = clickedTab.dataset.category;

                $$('.tab-btn', this).forEach(btn => {
                    const panel = $(`#${btn.getAttribute('aria-controls')}`, this);
                    if (btn === clickedTab) {
                        btn.classList.add('border-sky-500', 'text-sky-600', 'dark:text-sky-500');
                        btn.classList.remove('border-transparent', 'text-slate-500', 'hover:text-slate-700', 'dark:hover:text-slate-300');
                        btn.setAttribute('aria-selected', 'true');
                        panel.classList.remove('hidden');
                        this.renderTableAndAccordion(category); // Re-render content on tab click
                    } else {
                        btn.classList.remove('border-sky-500', 'text-sky-600', 'dark:text-sky-500');
                        btn.classList.add('border-transparent', 'text-slate-500', 'hover:text-slate-700', 'dark:hover:text-slate-300');
                        btn.setAttribute('aria-selected', 'false');
                        panel.classList.add('hidden');
                    }
                });
            }

            /** Handles a checkbox being checked or unchecked. */
            handleCheckboxChange(checkbox) {
                const { address } = checkbox.dataset;
                const isInspected = checkbox.checked;
                this.saveInspectedState(address, isInspected);
                
                const device = this.data.devices.find(d => String(d.address) === address);
                const category = this.getDeviceCategory(device.deviceType);
                this.updateUI(category);
            }
            
            /** Handles a click on a sortable table header. */
            handleSort(category, key) {
                const currentSort = this.sortState[category];
                let newDir = (currentSort?.key === key && currentSort.dir === 'asc') ? 'desc' : 'asc';
                this.sortState[category] = { key, dir: newDir };
                this.updateUI(category);
            }
            
            /** Handles clicks on the main action buttons. */
            handleGlobalAction(action) {
                const allAddresses = this.data.devices.map(d => d.address);
                if (action === 'mark-all') {
                    if (!confirm("Are you sure you want to mark all devices as inspected?")) return;
                    allAddresses.forEach(address => this.saveInspectedState(address, true));
                }
                if (action === 'clear-all') {
                    if (!confirm("Are you sure you want to clear all inspection checkmarks?")) return;
                    allAddresses.forEach(address => this.saveInspectedState(address, false));
                }
                if (action === 'export') {
                    this.exportInspectedList();
                    return;
                }
                // Re-render all visible categories after action
                $$('[role=tabpanel]').forEach(panel => {
                    if(!panel.classList.contains('hidden')) {
                        const category = panel.dataset.category;
                        this.updateUI(category);
                    }
                });
                showToast(`Action '${action}' completed.`, 'success');
            }

            /** Exports a JSON file of the currently inspected devices. */
            exportInspectedList() {
                const inspectedAddresses = Array.from(this.inspected);
                const data = JSON.stringify({
                    checklistName: this.data.name,
                    inspectedCount: inspectedAddresses.length,
                    inspectedAddresses: inspectedAddresses
                }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.checklistKey}-inspected.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Exported inspected list.', 'info');
            }

            /** Filters a table based on search input. */
            filterTable(category, query) {
                const q = query.toLowerCase();
                const categoryId = category.replace(/\s/g, '').replace('&', 'And');
                const panel = $(`#panel-${categoryId}`, this);
                $$('tbody tr', panel).forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(q) ? '' : 'none';
                });
            }
            
            /** Updates the UI for a specific category (tables and progress bar). */
            updateUI(category) {
                const categoryId = category.replace(/\s/g, '').replace('&', 'And');
                const panel = $(`#panel-${categoryId}`, this);
                if (!panel || panel.classList.contains('hidden')) return;

                // Full re-render of the table and accordion for the category
                this.renderTableAndAccordion(category);

                // Update progress bar
                const allDevices = this.data.devices.filter(d => this.getDeviceCategory(d.deviceType) === category);
                const inspectedCount = allDevices.filter(d => this.inspected.has(d.address)).length;
                const total = allDevices.length;
                const percent = total > 0 ? Math.round((inspectedCount / total) * 100) : 0;
                
                const progressText = panel.querySelector('.flex.justify-between span:last-child');
                const progressBar = panel.querySelector('.bg-sky-600');
                if(progressText) progressText.textContent = `${inspectedCount} / ${total} inspected (${percent}%)`;
                if(progressBar) progressBar.style.width = `${percent}%`;
            }
        }
        customElements.define('checklist-workspace', ChecklistWorkspace);

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize UI Picker Components
            $('#mobile-building-picker-container').appendChild(document.createElement('building-picker'));
            $('#desktop-building-picker-container').appendChild(document.createElement('building-picker'));

            // 2. Handle checklist selection
            document.addEventListener('checklist-selected', (e) => {
                const { key } = e.detail;
                const workspaceContainer = $('#checklist-workspace');
                $('#welcome-message')?.remove(); // Remove initial welcome message
                
                let workspace = $('checklist-workspace', workspaceContainer);
                if (!workspace) {
                    workspace = document.createElement('checklist-workspace');
                    workspaceContainer.innerHTML = ''; // Clear container before adding
                    workspaceContainer.appendChild(workspace);
                }
                // Set the building-key attribute to trigger the workspace update
                workspace.setAttribute('building-key', key);
            });
        });
    </script>

</body>
</html>
